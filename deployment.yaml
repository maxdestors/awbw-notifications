steps:
  # Deploy image to Cloud Run
  - id: Cloud Run Deployment
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_SERVICE_NAME}
      - --image
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_SERVICE_NAME}:${_APP_VERSION}
      - --region
      - ${_REGION}
      - --set-env-vars
      - APP_VERSION=${_APP_VERSION},BUCKET_NAME=${_BUCKET_NAME},STATE_OBJECT=${_STATE_OBJECT}
      - --service-account
      - ${_RUN_SA_EMAIL}

  # Deploy update or create Scheduler
  - id: Deploy Cloud Scheduler
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: bash
    args:
      - -c
      - |
        set -e

        RUN_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region ${_REGION} \
          --format='value(status.url)')

        echo "Cloud Run URL: $RUN_URL"

        JOB_URI="$RUN_URL${_SCHEDULER_URI}"

        echo "== Configure Cloud Scheduler =="
        if gcloud scheduler jobs describe ${_SCHEDULER_JOB} --location ${_REGION} >/dev/null 2>&1; then
          echo "Updating existing scheduler job..."
          gcloud scheduler jobs update http ${_SCHEDULER_JOB} \
            --location ${_REGION} \
            --schedule "${_SCHEDULER_CRON}" \
            --time-zone "${_SCHEDULER_TZ}" \
            --http-method POST \
            --uri "$JOB_URI"
            # --oidc-service-account-email "${_SCHED_SA_EMAIL}" \
            # --oidc-token-audience "$RUN_URL"
        else
          echo "Creating scheduler job..."
          gcloud scheduler jobs create http ${_SCHEDULER_JOB} \
            --location ${_REGION} \
            --schedule "${_SCHEDULER_CRON}" \
            --time-zone "${_SCHEDULER_TZ}" \
            --http-method POST \
            --uri "$JOB_URI"
            # --oidc-service-account-email "${_SCHED_SA_EMAIL}" \
            # --oidc-token-audience "$RUN_URL"
        fi

        echo "== Done =="

substitutions:
  _REGION: europe-west1
  _APP_VERSION: $COMMIT_SHA

  # Cloud Run service name AND image name (kept same here)
  _SERVICE_NAME: awbw-notifier

  # Artifact Registry repository name (THIS is the missing segment)
  _AR_REPO: awbw-notifier   # <-- change to your actual AR repo name

  _BUCKET_NAME: awbw-notifier-prod
  _STATE_OBJECT: state.json

  _RUN_SA_EMAIL: awbw-notifier-run-sa@YOUR_PROJECT_ID.iam.gserviceaccount.com
  _SCHED_SA_EMAIL: awbw-notifier-scheduler-sa@YOUR_PROJECT_ID.iam.gserviceaccount.com

  _SCHEDULER_JOB: awbw-notifier-job
  _SCHEDULER_CRON: '1-59/9 7-22 * * *'
  _SCHEDULER_TZ: Europe/Paris
  _SCHEDULER_URI: /run

options:
  logging: CLOUD_LOGGING_ONLY

# OPTIONAL: only include this if you're explicitly setting build.service_account somewhere
# serviceAccount: projects/$PROJECT_ID/serviceAccounts/<YOUR_BUILD_SA>@$PROJECT_ID.iam.gserviceaccount.com
